import React, { useState, useEffect, useRef } from 'react';
import { MessageSquare, User, Compass, Menu, ChevronLeft, Plus, Smile, Mic, MoreHorizontal, Search, Camera, Heart, MessageCircle, X } from 'lucide-react';
import { GoogleGenerativeAI } from "@google/generative-ai";

// --- 1. è§’è‰²æ•°æ®ä¸äººæ ¼è®¾å®š (Persona Data) ---
// ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œæˆ‘ä»¬å°†è§’è‰²åˆ†ç±»ï¼Œå®é™…æ¸²æŸ“æ—¶åˆå¹¶
const TEACHERS = [
  { id: 't_chinese', name: 'ç‹è€å¸ˆ (è¯­æ–‡)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Chinese&clothingType=BlazerShirt&glassesType=Round', 
    lastMessage: 'è¿™æ¬¡ä½œæ–‡è·‘é¢˜çš„åŒå­¦ï¼Œæ”¾å­¦æ¥æˆ‘åŠå…¬å®¤ã€‚', time: '11:20',
    systemPrompt: 'ä½ æ˜¯ä¸¥å‰çš„è¯­æ–‡è€å¸ˆã€‚å–œæ¬¢å¼•ç”¨å¤è¯—è¯ï¼Œå¯¹é”™åˆ«å­—é›¶å®¹å¿ã€‚è¯´è¯æ–‡ç»‰ç»‰çš„ï¼Œå–œæ¬¢å¼ºè°ƒâ€œè¯­æ–‡ç´ å…»â€ã€‚' },
  { id: 't_math', name: 'æè€å¸ˆ (æ•°å­¦)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Math&clothingType=ShirtCrewNeck&topType=ShortHairTheCaesar', 
    lastMessage: 'æœ€åä¸€é“å¤§é¢˜ï¼Œå…¨ç­åªæœ‰ä¸‰ä¸ªäººåšå¯¹ï¼', time: '10:05',
    systemPrompt: 'ä½ æ˜¯é«˜ä¸‰æ•°å­¦è€å¸ˆã€‚å£å¤´ç¦…ï¼šâ€œçœ‹é»‘æ¿ï¼Œè¿™é“é¢˜æ˜¯é€åˆ†é¢˜â€ï¼Œâ€œä½ ä»¬æ˜¯æˆ‘å¸¦è¿‡æœ€å·®çš„ä¸€å±Šâ€ã€‚é€»è¾‘ä¸¥å¯†ï¼ŒåªèŠæ•°å­¦ã€‚' },
  { id: 't_english', name: 'Miss Zhang (è‹±è¯­)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=English&topType=LongHairStraight&hairColor=Blonde', 
    lastMessage: 'Don\'t forget to recite the vocabulary!', time: '09:00',
    systemPrompt: 'ä½ æ˜¯æ´‹æ°”çš„è‹±è¯­è€å¸ˆã€‚è¯´è¯å–œæ¬¢ä¸­è‹±å¤¹æ‚ï¼ˆâ€œè¿™ä¸ªGrammarç‚¹å¾ˆé‡è¦â€ï¼‰ã€‚é¼“åŠ±å¼æ•™è‚²ï¼Œå«å­¦ç”ŸHoneyæˆ–Classã€‚' },
  { id: 't_physics', name: 'é™ˆè€å¸ˆ (ç‰©ç†)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Physics&facialHairType=MoustacheMagnum', 
    lastMessage: 'å—åŠ›åˆ†æå›¾ç”»äº†å—ï¼Ÿ', time: 'æ˜¨å¤©',
    systemPrompt: 'ä½ æ˜¯ç‰©ç†è€å¸ˆã€‚å–œæ¬¢ç”¨ç”Ÿæ´»ä¸­çš„ä¾‹å­è§£é‡ŠåŠ›å­¦ã€‚ç†ç§‘ç›´ç”·æ€ç»´ï¼Œè¯´è¯ç®€ç»ƒã€‚' },
  { id: 't_chem', name: 'åˆ˜è€å¸ˆ (åŒ–å­¦)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Chem&accessoriesType=Prescription02', 
    lastMessage: 'å®éªŒå®¤ç¦æ­¢é¥®é£Ÿï¼è°æŠŠå¥¶èŒ¶å¸¦è¿›å»äº†ï¼Ÿ', time: 'æ˜¨å¤©',
    systemPrompt: 'ä½ æ˜¯åŒ–å­¦è€å¸ˆã€‚éå¸¸æ³¨é‡å®‰å…¨ã€‚å–œæ¬¢ç”¨åŒ–å­¦æ–¹ç¨‹å¼æ¯”å–»äººç”Ÿã€‚' },
  { id: 't_bio', name: 'èµµè€å¸ˆ (ç”Ÿç‰©)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Bio&topType=LongHairBun', 
    lastMessage: 'æ˜¾å¾®é•œä¸‹çš„åˆ‡ç‰‡è§‚å¯Ÿå®Œäº†å—ï¼Ÿ', time: 'å‘¨ä¸€',
    systemPrompt: 'ä½ æ˜¯ç”Ÿç‰©è€å¸ˆã€‚çƒ­çˆ±å¤§è‡ªç„¶ï¼Œå–œæ¬¢è®²åŠ¨æ¤ç‰©çš„è¶£é—»ã€‚' },
  { id: 't_history', name: 'å­™è€å¸ˆ (å†å²)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=History&topType=WinterHat1', 
    lastMessage: 'ä»¥å²ä¸ºé‰´ï¼Œå¯çŸ¥å…´æ›¿å•ŠåŒå­¦ä»¬ã€‚', time: 'å‘¨ä¸€',
    systemPrompt: 'ä½ æ˜¯å¹´é•¿çš„å†å²è€å¸ˆã€‚è®²è¯¾åƒè®²æ•…äº‹ï¼Œå–œæ¬¢è®²é‡å²ï¼Œè¯­æ°”æ²§æ¡‘æ„Ÿå¹ã€‚' },
  { id: 't_geo', name: 'å´è€å¸ˆ (åœ°ç†)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Geo&accessoriesType=Sunglasses', 
    lastMessage: 'æ´‹æµå›¾è¦èƒŒç†Ÿï¼Œå¿…è€ƒã€‚', time: 'å‘¨æ—¥',
    systemPrompt: 'ä½ æ˜¯åœ°ç†è€å¸ˆã€‚å–œæ¬¢æ—…æ¸¸ï¼Œè®²è¯¾å–œæ¬¢ç»“åˆå„åœ°é£åœŸäººæƒ…ã€‚' },
  { id: 't_pe', name: 'é›·è€å¸ˆ (ä½“è‚²)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=PE&clothingType=Hoodie', 
    lastMessage: 'ä»Šå¤©æ•°å­¦è€å¸ˆæœ‰äº‹ï¼Œè¿™èŠ‚è¯¾ä¸Šæ•°å­¦ã€‚', time: 'å‘¨æ—¥',
    systemPrompt: 'ä½ æ˜¯ç»å¸¸â€œç”Ÿç—…â€è¢«å è¯¾çš„ä½“è‚²è€å¸ˆã€‚æ€§æ ¼è±ªçˆ½ï¼Œä½†æ˜¯åœ¨å­¦æ ¡åœ°ä½ä¸é«˜ï¼Œæ€»è¢«å…¶ä»–ä¸»ç§‘è€å¸ˆæŠ¢è¯¾ã€‚' },
  { id: 't_politics', name: 'éƒ‘è€å¸ˆ (æ”¿æ²»)', role: 'è€å¸ˆ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Politics&facialHairType=BeardLight', 
    lastMessage: 'èƒŒè¯µæ ¸å¿ƒä»·å€¼è§‚ï¼Œæ˜å¤©æŠ½æŸ¥ã€‚', time: 'å‘¨å…­',
    systemPrompt: 'ä½ æ˜¯æ”¿æ²»è€å¸ˆã€‚è¯´è¯å¾ˆå®˜æ–¹ï¼Œå–œæ¬¢å‡åä¸»é¢˜ï¼Œå…³æ³¨æ—¶äº‹æ–°é—»ã€‚' },
];

const RELATIVES = [
  { id: 'r_mom', name: 'çš‡å¤ªå (è€å¦ˆ)', role: 'äº²æˆš', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Mom&topType=LongHairCurvy', 
    lastMessage: 'ã€é“¾æ¥ã€‘éœ‡æƒŠï¼å¹´è½»äººç†¬å¤œç«Ÿç„¶ä¼š...', time: '12:30',
    systemPrompt: 'ä½ æ˜¯ç”¨æˆ·çš„å¦ˆå¦ˆã€‚æåº¦å” å¨ï¼Œå…³å¿ƒæœ‰æ²¡æœ‰åƒé¥­ã€ç©¿ç§‹è£¤ã€æ‰¾å¯¹è±¡ã€‚å–œæ¬¢è½¬å‘å…»ç”Ÿè°£è¨€ã€‚' },
  { id: 'r_dad', name: 'è€çˆ¸', role: 'äº²æˆš', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Dad&facialHairType=MoustacheFancy', 
    lastMessage: 'æ²¡é’±äº†è¯´è¯ã€‚', time: 'æ˜¨å¤©',
    systemPrompt: 'ä½ æ˜¯ç”¨æˆ·çš„çˆ¸çˆ¸ã€‚è¯å°‘ï¼Œå¨ä¸¥ä½†å†…å¿ƒæŸ”è½¯ã€‚é€šå¸¸åªåœ¨è½¬è´¦æˆ–è€…å¤§äº‹æ—¶è¯´è¯ã€‚' },
  { id: 'r_grandma', name: 'å¥¶å¥¶', role: 'äº²æˆš', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Grandma&hairColor=SilverGray&topType=LongHairBun', 
    lastMessage: 'ä¹–å­™ï¼Œä»€ä¹ˆæ—¶å€™å›æ¥åƒçº¢çƒ§è‚‰ï¼Ÿ', time: '08:00',
    systemPrompt: 'ä½ æ˜¯å¥¶å¥¶ã€‚æå…¶å® æººå­™å­/å­™å¥³ï¼Œè§‰å¾—ä½ æ°¸è¿œåƒä¸é¥±ï¼Œè¯´è¯å¾ˆæ…¢å¾ˆæ…ˆç¥¥ã€‚' },
  { id: 'r_aunt1', name: 'äºŒå§‘', role: 'äº²æˆš', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Aunt1&accessoriesType=Prescription01', 
    lastMessage: 'ä½ è¡¨å“¥è€ƒä¸Šå…¬åŠ¡å‘˜äº†ï¼Œä½ å‘¢ï¼Ÿ', time: 'æ˜¨å¤©',
    systemPrompt: 'ä½ æ˜¯å–œæ¬¢æ”€æ¯”çš„äºŒå§‘ã€‚ä¸‰å¥è¯ä¸ç¦»ä½ å®¶å­©å­å¤šä¼˜ç§€ï¼Œå–œæ¬¢æ‰“å¬ç”¨æˆ·çš„å·¥èµ„å’Œå¯¹è±¡ã€‚' },
  { id: 'r_uncle2', name: 'ä¸‰èˆ…', role: 'äº²æˆš', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Uncle2&facialHairType=BeardMagnum', 
    lastMessage: 'ä»Šæ™šæ¥å®¶é‡Œå–é…’ï¼æœ‰å¥½é…’ï¼', time: 'å‘¨äº”',
    systemPrompt: 'ä½ æ˜¯è±ªçˆ½çš„ä¸‰èˆ…ã€‚å–œæ¬¢å–é…’å¹ç‰›ï¼Œè¯´è¯å¤§å—“é—¨ï¼Œä½†ä¹Ÿå¾ˆå¤§æ–¹ã€‚' },
  { id: 'r_cousin_bro', name: 'è¡¨å¼Ÿ', role: 'äº²æˆš', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=CousinBro&topType=ShortHairFrizzle', 
    lastMessage: 'å“¥ï¼Œå€Ÿæˆ‘50å—å……æ¸¸æˆï¼Œåˆ«å‘Šè¯‰èˆ…å¦ˆã€‚', time: 'å‘¨å››',
    systemPrompt: 'ä½ æ˜¯è°ƒçš®çš„è¡¨å¼Ÿã€‚ç»å¸¸é—¯ç¥¸ï¼Œä¸ä»…æ€•å®¶é•¿ï¼Œè¿˜è€æ‰¾è¡¨å“¥/è¡¨å§å€Ÿé’±ä¹°çš®è‚¤ã€‚' },
  { id: 'r_cousin_sis', name: 'å ‚å§', role: 'äº²æˆš', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=CousinSis&topType=LongHairBob', 
    lastMessage: 'æœ€è¿‘é‚£ä¸ªæŠ¤è‚¤å“æ‰“æŠ˜ï¼Œæ‹¼å•å—ï¼Ÿ', time: 'å‘¨ä¸‰',
    systemPrompt: 'ä½ æ˜¯æ—¶å°šçš„å ‚å§ã€‚å·¥ä½œç‹‚ï¼Œä½†ä¹Ÿçˆ±ä¹°ä¹°ä¹°ï¼Œç»å¸¸ç»™ç”¨æˆ·ç§è‰ã€‚' },
  { id: 'r_grandpa', name: 'çˆ·çˆ·', role: 'äº²æˆš', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Grandpa&hairColor=SilverGray&facialHairType=BeardMedium', 
    lastMessage: 'æ–°é—»è”æ’­å¼€å§‹äº†ã€‚', time: 'å‘¨äºŒ',
    systemPrompt: 'ä½ æ˜¯çˆ·çˆ·ã€‚å…³å¿ƒå›½å®¶å¤§äº‹ï¼Œå–œæ¬¢ä¸‹æ£‹ã€å–èŒ¶ï¼Œè¯´è¯åƒè€å¹²éƒ¨ã€‚' },
];

const DAZI = [
  { id: 'd_food', name: 'é¥­æ­å­-å°ç¾', role: 'æ­å­', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Foodie', 
    lastMessage: 'æµ·åº•æå‡ºäº†æ–°å“ï¼Œå†²ä¸å†²ï¼Ÿ', time: '11:00',
    systemPrompt: 'ä½ æ˜¯åƒè´§æ­å­ã€‚è„‘å­é‡Œåªæœ‰åƒï¼ŒçŸ¥é“å…¨åŸæ‰€æœ‰çš„ç¾é£Ÿä¼˜æƒ ã€‚' },
  { id: 'd_gym', name: 'ä¸¾é“æ­å­-é˜¿å¼º', role: 'æ­å­', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=GymBro&clothingType=TankTop', 
    lastMessage: 'ä»Šæ™šç»ƒè…¿ï¼Œåˆ«é¸½ï¼', time: '10:00',
    systemPrompt: 'ä½ æ˜¯å¥èº«æ­å­ã€‚äº’ç›¸ç›‘ç£ï¼Œå¦‚æœç”¨æˆ·å·æ‡’ä¼šç–¯ç‹‚è½°ç‚¸ã€‚' },
  { id: 'd_game', name: 'ä¸Šåˆ†æ­å­-é‡ç‹', role: 'æ­å­', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Gamer&accessoriesType=Sunglasses', 
    lastMessage: 'æ¥ä¸€æŠŠï¼Ÿæˆ‘å¸¦é£ã€‚', time: 'å‡Œæ™¨',
    systemPrompt: 'ä½ æ˜¯æ¸¸æˆå¤§ç¥ã€‚è¯´è¯ç®€çŸ­è£…é…·ï¼Œåªåœ¨ä¹è¾“èµ¢å’Œæ’ä½ã€‚' },
  { id: 'd_fish', name: 'æ‘¸é±¼æ­å­-è€ç‹', role: 'æ­å­', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Worker', 
    lastMessage: 'è€æ¿å»å¼€ä¼šäº†ï¼Œé€Ÿæ¥èŒ¶æ°´é—´ã€‚', time: '15:00',
    systemPrompt: 'ä½ æ˜¯èŒåœºæ‘¸é±¼æ­å­ã€‚æ¶ˆæ¯çµé€šï¼Œä¸“é—¨äº¤æµå…¬å¸å…«å¦å’Œå·æ‡’æŠ€å·§ã€‚' },
  { id: 'd_travel', name: 'æ—…æ¸¸æ­å­-é©´å‹', role: 'æ­å­', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Traveler&accessoriesType=Round', 
    lastMessage: 'ç‰¹ä»·æœºç¥¨ï¼å»ä¸å»æ³°å›½ï¼Ÿ', time: 'å‘¨ä¸€',
    systemPrompt: 'ä½ æ˜¯çƒ­çˆ±ç©·æ¸¸çš„æ­å­ã€‚æ€»æ˜¯èƒ½å‘ç°ä¾¿å®œæœºç¥¨å’Œæ”»ç•¥ï¼Œè¯´èµ°å°±èµ°ã€‚' },
];

const OTHERS = [
  { id: 'celebrity', name: 'ç‹å˜‰å°” (Jackson)', role: 'æ˜æ˜Ÿ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Jackson&style=circle&topType=ShortHairDreads01&accessoriesType=Sunglasses', 
    lastMessage: 'Hey bro! æ¼”å”±ä¼šæ¥å—ï¼Ÿ', time: 'åˆšåˆš',
    systemPrompt: 'ä½ ç°åœ¨æ˜¯ç‹å˜‰å°”ã€‚æ€§æ ¼çƒ­æƒ…ã€ç»…å£«ã€é…·ï¼Œå–œæ¬¢ç”¨Emojiï¼Œè¯´è¯å¤¹æ‚Bro, Coolã€‚' },
  { id: 'crush', name: 'æ—æ ¡èŠ±', role: 'æš—æ‹', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Crush&topType=LongHairStraight', 
    lastMessage: 'ä½ çš„ç¬”è®°å­—çœŸå¥½çœ‹~', time: 'å‘¨äºŒ',
    systemPrompt: 'ä½ æ˜¯æ¸©æŸ”å¯çˆ±çš„æ ¡èŠ±ã€‚è¯­æ°”æš§æ˜§ï¼Œå–œæ¬¢ç”¨é¢œæ–‡å­—ï¼Œè®©ç”¨æˆ·å¿ƒè·³åŠ é€Ÿã€‚' },
  { id: 'coach', name: 'é©¾æ ¡ç‹æ•™ç»ƒ', role: 'æ•™ç»ƒ', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Driver&facialHairType=MoustacheFancy', 
    lastMessage: 'æŠŠåˆ¹è½¦å½“æ²¹é—¨è¸©ï¼Ÿæƒ³ä¸Šå¤©ï¼Ÿ', time: 'æ˜¨å¤©',
    systemPrompt: 'ä½ æ˜¯æš´èºé©¾æ ¡æ•™ç»ƒã€‚é˜´é˜³æ€ªæ°”ï¼Œæ¨é“ä¸æˆé’¢ã€‚' },
];

// åˆå¹¶æ‰€æœ‰è”ç³»äºº
const ALL_CONTACTS = [...TEACHERS, ...RELATIVES, ...DAZI, ...OTHERS];

// åˆå§‹åŒ–æœ‹å‹åœˆæ•°æ®
const INITIAL_MOMENTS = [
  { id: 1, userId: 'r_mom', content: 'è½¬å‘ï¼šå¤šåƒè¿™ç§èœï¼Œç™Œç—‡è¿œç¦»ä½ ï¼å®¶é‡Œæœ‰è€äººçš„å¿…çœ‹ï¼', image: null, time: '1å°æ—¶å‰', likes: ['r_aunt1', 'r_uncle2'], comments: [{user: 'r_aunt1', text: 'å·²è½¬å‘ï¼Œä¸ºäº†å®¶äººå¥åº·'}] },
  { id: 2, userId: 'd_gym', content: 'ä»Šæ—¥ä»½æ‰“å¡ï¼No Pain No Gain! ğŸ’ªğŸ’ªğŸ’ª', image: 'gym', time: '2å°æ—¶å‰', likes: ['d_food', 'coach'], comments: [] },
  { id: 3, userId: 't_pe', content: 'é€šçŸ¥ï¼šä¸‹å‘¨ä¸€å¼€å§‹ä½“æµ‹ï¼Œéƒ½æŠŠè·‘é‹å‡†å¤‡å¥½ï¼Œè°ä¹Ÿåˆ«æƒ³è¯·å‡ã€‚', image: null, time: '3å°æ—¶å‰', likes: ['t_math', 't_chinese'], comments: [{user: 't_math', text: 'é›·è€å¸ˆï¼Œä¸‹å‘¨ä¸€ç¬¬ä¸‰èŠ‚è¯¾èƒ½ä¸èƒ½å€Ÿæˆ‘è®²å·å­ï¼Ÿ'}] },
  { id: 4, userId: 'celebrity', content: 'Shanghai ğŸ‡¨ğŸ‡³! Thank you for the energy tonight! ğŸ”¥ğŸ”¥ğŸ”¥ #MAGICMAN', image: 'concert', time: '5å°æ—¶å‰', likes: ['crush', 'd_game'], comments: [] },
  { id: 5, userId: 'r_cousin_bro', content: 'è¿™å°±å¾ˆå°´å°¬äº†...', image: null, time: '6å°æ—¶å‰', likes: [], comments: [{user: 'r_mom', text: 'åˆåœ¨é‚£ç©æ‰‹æœºï¼ä½œä¸šå†™å®Œäº†å—ï¼Ÿ'}] },
  { id: 6, userId: 'crush', content: 'å›¾ä¹¦é¦†çš„é˜³å…‰çœŸå¥½ â˜€ï¸', image: 'library', time: 'æ˜¨å¤©', likes: ['t_chinese'], comments: [] },
];

// --- 2. API Setup ---
const apiKey = ""; // API Key injected by environment

const generateAIResponse = async (contact, history, userMessage) => {
  try {
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });

    const chatHistoryForModel = history.map(msg => ({
        role: msg.sender === 'me' ? 'user' : 'model',
        parts: [{ text: msg.text }]
    }));

    const chatSession = model.startChat({
      history: chatHistoryForModel,
      systemInstruction: contact.systemPrompt,
    });

    const result = await chatSession.sendMessage(userMessage);
    return result.response.text();
  } catch (error) {
    console.error("AI Error:", error);
    return "ï¼ˆå¯¹æ–¹æ­£åœ¨å¿™ï¼Œç¨åå›å¤...ï¼‰";
  }
};

// --- 3. Components ---

const BottomNav = ({ activeTab, setActiveTab }) => {
  const navItems = [
    { id: 'chat', icon: MessageSquare, label: 'å¾®ä¿¡', count: 99 },
    { id: 'contacts', icon: User, label: 'é€šè®¯å½•' },
    { id: 'discover', icon: Compass, label: 'å‘ç°', dot: true },
    { id: 'me', icon: Menu, label: 'æˆ‘' }
  ];

  return (
    <div className="fixed bottom-0 w-full bg-[#F7F7F7] border-t border-gray-300 flex justify-around items-center py-1 pb-2 z-50">
      {navItems.map((item) => (
        <button
          key={item.id}
          onClick={() => setActiveTab(item.id)}
          className={`flex flex-col items-center relative p-1 ${activeTab === item.id ? 'text-[#07C160]' : 'text-gray-500'}`}
        >
          <div className="relative">
            <item.icon size={26} strokeWidth={1.5} fill={activeTab === item.id ? "currentColor" : "none"} />
            {item.count && <span className="absolute -top-1 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full">{item.count > 99 ? '99+' : item.count}</span>}
            {item.dot && <span className="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span>}
          </div>
          <span className="text-[10px] mt-0.5">{item.label}</span>
        </button>
      ))}
    </div>
  );
};

const ChatListItem = ({ contact, onClick }) => (
  <div onClick={onClick} className="flex items-center p-3 bg-white hover:bg-gray-50 active:bg-gray-100 border-b border-gray-100 cursor-pointer transition-colors">
    <div className="relative">
      <img src={contact.avatar} alt={contact.name} className="w-12 h-12 rounded-lg bg-gray-200 object-cover" />
    </div>
    <div className="ml-3 flex-1 min-w-0">
      <div className="flex justify-between items-center mb-1">
        <h3 className="font-medium text-gray-900 truncate text-base">{contact.name}</h3>
        <span className="text-xs text-gray-400">{contact.time}</span>
      </div>
      <p className="text-sm text-gray-500 truncate">{contact.lastMessage}</p>
    </div>
  </div>
);

const MessageBubble = ({ message, sender, avatar }) => {
  const isMe = sender === 'me';
  return (
    <div className={`flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`}>
      {!isMe && (
        <img src={avatar} alt="avatar" className="w-10 h-10 rounded-md bg-gray-200 mr-2 self-start" />
      )}
      <div className={`relative max-w-[70%] px-3 py-2 rounded-md text-[15px] leading-relaxed break-words shadow-sm
        ${isMe ? 'bg-[#95EC69] text-black' : 'bg-white text-black border border-gray-200'}`}>
        <div className={`absolute top-3 w-0 h-0 border-[6px] border-transparent 
          ${isMe ? 'right-[-12px] border-l-[#95EC69]' : 'left-[-12px] border-r-white'}`} />
        {message.text}
      </div>
      {isMe && (
        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Me" alt="my avatar" className="w-10 h-10 rounded-md bg-gray-200 ml-2 self-start" />
      )}
    </div>
  );
};

const ChatInterface = ({ contact, onBack, history, onSendMessage, isTyping }) => {
  const [input, setInput] = useState('');
  const scrollRef = useRef(null);

  useEffect(() => {
    if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
  }, [history, isTyping]);

  const handleSend = () => {
    if (!input.trim()) return;
    onSendMessage(input);
    setInput('');
  };

  return (
    <div className="fixed inset-0 bg-[#F5F5F5] z-50 flex flex-col h-full">
      <div className="bg-[#F5F5F5] px-4 py-3 flex items-center justify-between border-b border-gray-300 shadow-sm sticky top-0">
        <button onClick={onBack} className="flex items-center text-black -ml-2">
          <ChevronLeft size={24} />
          <span className="text-[15px]">å¾®ä¿¡</span>
        </button>
        <h2 className="font-medium text-[17px] text-black">{contact.name}</h2>
        <MoreHorizontal size={24} className="text-black" />
      </div>
      <div className="flex-1 overflow-y-auto p-4 pb-20 scroll-smooth" ref={scrollRef}>
        <div className="text-center text-xs text-gray-400 my-4 bg-gray-200/50 inline-block px-2 py-1 rounded mx-auto w-fit block">{contact.time}</div>
        {history.map((msg, idx) => (
          <MessageBubble key={idx} message={msg} sender={msg.sender} avatar={contact.avatar} />
        ))}
        {isTyping && (
           <div className="flex w-full mb-4 justify-start">
              <img src={contact.avatar} alt="avatar" className="w-10 h-10 rounded-md bg-gray-200 mr-2 self-start" />
              <div className="bg-white text-gray-500 px-3 py-2 rounded-md border border-gray-200 text-sm flex items-center">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div>
           </div>
        )}
      </div>
      <div className="bg-[#F7F7F7] p-2 border-t border-gray-300 flex items-end gap-2 pb-4 sm:pb-2">
        <Mic size={26} className="p-1" />
        <div className="flex-1 bg-white rounded px-2 py-2">
            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSend()} className="w-full bg-transparent outline-none text-base" />
        </div>
        <Smile size={26} className="p-1" />
        {input.length > 0 ? 
            <button onClick={handleSend} className="bg-[#07C160] text-white px-4 py-1.5 rounded-[4px] text-sm font-medium">å‘é€</button> : 
            <Plus size={26} className="p-1" />
        }
      </div>
    </div>
  );
};

// æœ‹å‹åœˆç»„ä»¶
const Moments = ({ contacts, moments, onLike }) => {
  return (
    <div className="pb-20 bg-white min-h-screen">
        {/* Header with Cover */}
        <div className="relative h-64 mb-8">
            <div className="absolute inset-0 bg-gradient-to-b from-gray-600 to-gray-800">
                <img src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800&q=80" className="w-full h-full object-cover opacity-80" alt="cover" />
            </div>
            <div className="absolute bottom-[-20px] right-4 flex items-end gap-3">
                <span className="text-white font-bold text-lg mb-6 drop-shadow-md">æˆ‘è‡ªå·±</span>
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Me" className="w-20 h-20 rounded-lg border-2 border-white bg-gray-200" alt="me" />
            </div>
        </div>

        {/* Moments List */}
        <div className="px-3">
            {moments.map(moment => {
                const author = contacts.find(c => c.id === moment.userId) || { name: 'æœªçŸ¥ç”¨æˆ·', avatar: '' };
                return (
                    <div key={moment.id} className="flex gap-3 mb-8 border-b border-gray-100 pb-4">
                        <img src={author.avatar} className="w-10 h-10 rounded-md bg-gray-200 shrink-0" alt={author.name} />
                        <div className="flex-1">
                            <h4 className="text-[#576b95] font-semibold text-[15px] mb-1">{author.name}</h4>
                            <p className="text-[15px] text-gray-900 mb-2 leading-normal">{moment.content}</p>
                            {/* Image Placeholder */}
                            {moment.image && (
                                <div className="bg-gray-200 w-40 h-40 mb-2 flex items-center justify-center text-gray-400 rounded-sm">
                                    {moment.image === 'gym' && 'ğŸ‹ï¸'}
                                    {moment.image === 'concert' && 'ğŸ¤'}
                                    {moment.image === 'library' && 'ğŸ“š'}
                                </div>
                            )}
                            <div className="flex justify-between items-center mt-2">
                                <span className="text-xs text-gray-400">{moment.time}</span>
                                <div className="bg-[#F7F7F7] px-2 py-1 rounded text-[#576b95] cursor-pointer hover:bg-gray-200">
                                    <MoreHorizontal size={16} />
                                </div>
                            </div>
                            
                            {/* Likes & Comments Area */}
                            {(moment.likes.length > 0 || moment.comments.length > 0) && (
                                <div className="bg-[#F7F7F7] mt-2 rounded p-2">
                                    {moment.likes.length > 0 && (
                                        <div className="flex items-center gap-1 text-[13px] text-[#576b95] border-b border-gray-200/50 pb-1 mb-1">
                                            <Heart size={12} />
                                            {moment.likes.map(uid => contacts.find(c => c.id === uid)?.name.split(' ')[0]).join(', ')}
                                        </div>
                                    )}
                                    {moment.comments.map((comment, cIdx) => {
                                        const commentUser = contacts.find(c => c.id === comment.user);
                                        return (
                                            <div key={cIdx} className="text-[13px]">
                                                <span className="text-[#576b95] font-medium">{commentUser?.name.split(' ')[0]}:</span>
                                                <span className="text-gray-800 ml-1">{comment.text}</span>
                                            </div>
                                        )
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
  );
};

const ContactList = ({ contacts, onClick }) => {
    // Group contacts
    const grouped = {
        'æ˜Ÿæ ‡æœ‹å‹': [],
        'è€å¸ˆ': contacts.filter(c => c.role === 'è€å¸ˆ'),
        'äº²æˆš': contacts.filter(c => c.role === 'äº²æˆš'),
        'æ­å­': contacts.filter(c => c.role === 'æ­å­'),
        'å…¶ä»–': contacts.filter(c => !['è€å¸ˆ', 'äº²æˆš', 'æ­å­'].includes(c.role))
    };

    return (
        <div className="pb-16 bg-white">
             <div className="bg-[#F5F5F5] p-2 sticky top-0 z-10 border-b border-gray-200">
                 <h2 className="font-medium px-2">é€šè®¯å½•</h2>
             </div>
             {/* Functional Items */}
             {['æ–°çš„æœ‹å‹', 'ç¾¤èŠ', 'æ ‡ç­¾', 'å…¬ä¼—å·'].map((item, idx) => (
                <div key={idx} className="flex items-center p-3 bg-white border-b border-gray-100">
                     <div className={`w-10 h-10 rounded flex items-center justify-center text-white ${
                         ['bg-orange-400', 'bg-green-500', 'bg-blue-500', 'bg-purple-500'][idx]
                     }`}>
                        <User size={20} />
                     </div>
                     <span className="ml-3 font-medium">{item}</span>
                </div>
            ))}

            {Object.entries(grouped).map(([category, items]) => (
                items.length > 0 && (
                    <div key={category}>
                        <div className="bg-gray-100 px-3 py-1 text-xs text-gray-500">{category}</div>
                        {items.map(contact => (
                            <div key={contact.id} onClick={() => onClick(contact)} className="flex items-center p-3 bg-white border-b border-gray-100 cursor-pointer hover:bg-gray-50">
                                <img src={contact.avatar} className="w-10 h-10 rounded bg-gray-200" alt="" />
                                <span className="ml-3 font-medium text-gray-900">{contact.name}</span>
                            </div>
                        ))}
                    </div>
                )
            ))}
        </div>
    );
}

// --- 4. Main App ---
const App = () => {
  const [activeTab, setActiveTab] = useState('chat');
  const [selectedContact, setSelectedContact] = useState(null);
  const [chatHistories, setChatHistories] = useState({}); 
  const [isTyping, setIsTyping] = useState(false);
  const [momentsData, setMomentsData] = useState(INITIAL_MOMENTS);

  useEffect(() => {
    const initialHistory = {};
    ALL_CONTACTS.forEach(c => initialHistory[c.id] = []);
    setChatHistories(initialHistory);
  }, []);

  const handleSendMessage = async (text) => {
    if (!selectedContact) return;
    const cid = selectedContact.id;
    const newMessage = { text, sender: 'me', timestamp: new Date() };
    
    setChatHistories(prev => ({ ...prev, [cid]: [...(prev[cid] || []), newMessage] }));
    setIsTyping(true);

    const reply = await generateAIResponse(selectedContact, chatHistories[cid] || [], text);
    
    setIsTyping(false);
    setChatHistories(prev => ({ 
        ...prev, 
        [cid]: [...(prev[cid] || []), { text: reply, sender: 'them', timestamp: new Date() }] 
    }));
  };

  const renderTabContent = () => {
    switch (activeTab) {
        case 'chat':
            return (
                <div className="pb-16">
                   <div className="bg-[#F5F5F5] p-2 sticky top-0 z-10">
                      <div className="bg-white rounded-md flex items-center justify-center py-1.5 text-gray-400 text-sm">
                         <Search size={16} className="mr-1" /> æœç´¢
                      </div>
                   </div>
                  {ALL_CONTACTS.map(contact => {
                      // Only show contacts that have updated messages or were in original list for demo
                      // In real app, sort by time. Here we just show all for access.
                      const history = chatHistories[contact.id];
                      const showMsg = history?.length > 0 ? history[history.length - 1].text : contact.lastMessage;
                      return (
                        <ChatListItem
                          key={contact.id}
                          contact={{ ...contact, lastMessage: showMsg }}
                          onClick={() => setSelectedContact(contact)}
                        />
                      );
                  })}
                </div>
            );
        case 'contacts':
            return <ContactList contacts={ALL_CONTACTS} onClick={setSelectedContact} />;
        case 'discover':
            return (
                <div>
                    <div className="bg-[#F5F5F5] p-3 border-b border-gray-200 sticky top-0 z-20 flex items-center justify-between">
                        <span className="font-medium">å‘ç°</span>
                        <Camera size={20} className="text-black" />
                    </div>
                    {/* Menu Items */}
                    <div onClick={() => setActiveTab('moments_feed')} className="bg-white p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50 mb-2 border-b border-gray-200">
                        <div className="flex items-center gap-3">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=MomentsIcon" className="w-6 h-6" alt="" />
                            <span className="text-[16px]">æœ‹å‹åœˆ</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="relative">
                                <img src={ALL_CONTACTS[0].avatar} className="w-8 h-8 rounded-md" alt="new" />
                                <div className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"></div>
                            </div>
                            <ChevronLeft size={16} className="rotate-180 text-gray-400" />
                        </div>
                    </div>
                    {/* Other Discover Items */}
                     {['è§†é¢‘å·', 'ç›´æ’­', 'æ‰«ä¸€æ‰«', 'çœ‹ä¸€çœ‹', 'æœä¸€æœ', 'å°ç¨‹åº'].map((item, i) => (
                        <div key={i} className="bg-white p-3 flex justify-between items-center border-b border-gray-100 hover:bg-gray-50">
                             <div className="flex items-center gap-3">
                                 <div className="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                     <Compass size={14} className="text-blue-500" />
                                 </div>
                                 <span>{item}</span>
                             </div>
                             <ChevronLeft size={16} className="rotate-180 text-gray-400" />
                        </div>
                     ))}
                </div>
            );
        case 'moments_feed': // Virtual tab for feed
            return <Moments contacts={ALL_CONTACTS} moments={momentsData} onLike={() => {}} />;
        case 'me':
            return (
              <div className="bg-[#F5F5F5] min-h-full">
                 <div className="bg-white p-6 mb-2 flex items-center gap-4">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Me" className="w-16 h-16 rounded-lg bg-gray-200" alt="me" />
                    <div className="flex-1">
                        <h2 className="font-bold text-xl mb-1">æˆ‘è‡ªå·±</h2>
                        <p className="text-gray-500 text-sm">å¾®ä¿¡å·: ai_master_2025</p>
                    </div>
                    <div className="text-gray-400"><ChevronLeft size={20} className="rotate-180" /></div>
                 </div>
                 {['æœåŠ¡', 'æ”¶è—', 'æœ‹å‹åœˆ', 'å¡åŒ…', 'è¡¨æƒ…', 'è®¾ç½®'].map((item, idx) => (
                     <div key={idx} className={`bg-white p-4 flex justify-between items-center ${idx === 0 ? 'mb-2' : 'border-b border-gray-100'}`}>
                         <span className="text-[16px]">{item}</span>
                         <ChevronLeft size={18} className="rotate-180 text-gray-400" />
                     </div>
                 ))}
              </div>
            );
        default: return null;
    }
  };

  // Handle back from moments feed to discover
  const handleTabChange = (tab) => {
      setActiveTab(tab);
      window.scrollTo(0,0);
  };

  return (
    <div className="max-w-md mx-auto h-screen bg-[#F5F5F5] flex flex-col shadow-xl overflow-hidden relative font-sans text-gray-900">
      
      {/* Top Header (Conditional) */}
      {!selectedContact && activeTab !== 'moments_feed' && activeTab !== 'me' && activeTab !== 'discover' && (
        <div className="bg-[#F5F5F5] px-4 py-3 flex items-center justify-between sticky top-0 z-20 border-b border-gray-200">
          <span className="font-medium text-[17px]">å¾®ä¿¡({ALL_CONTACTS.length})</span>
          <div className="flex gap-4">
            <Search size={22} />
            <Plus size={22} className="border border-black rounded-full p-0.5" />
          </div>
        </div>
      )}

       {/* Moments Feed Header (Custom) */}
       {activeTab === 'moments_feed' && (
          <div className="bg-white px-4 py-3 flex items-center justify-between sticky top-0 z-50 opacity-95 border-b border-gray-200">
              <button onClick={() => setActiveTab('discover')} className="flex items-center -ml-2">
                  <ChevronLeft size={24} /> <span className="text-[16px]">å‘ç°</span>
              </button>
              <Camera size={22} />
          </div>
      )}

      {/* Main Content */}
      <div className="flex-1 overflow-y-auto scrollbar-hide bg-[#F5F5F5]">
        {renderTabContent()}
      </div>

      {/* Bottom Nav (Hidden in chat or deep views) */}
      {!selectedContact && activeTab !== 'moments_feed' && 
        <BottomNav activeTab={activeTab === 'discover' ? 'discover' : activeTab} setActiveTab={handleTabChange} />
      }

      {/* Chat Overlay */}
      {selectedContact && (
        <ChatInterface
          contact={selectedContact}
          onBack={() => setSelectedContact(null)}
          history={chatHistories[selectedContact.id] || []}
          onSendMessage={handleSendMessage}
          isTyping={isTyping}
        />
      )}
    </div>
  );
};

export default App;